(()=>{"use strict";var e,a={626:(e,a,r)=>{r.d(a,{A:()=>i}),r(540);var t=r(375),s=r(848);const n=({effect:e})=>{const{attributes:a,listeners:r,setNodeRef:n,transform:i}=(0,t.PM)({id:`effect-${e.id}`,data:e}),o=i?{transform:`translate3d(${i.x}px, ${i.y}px, 0)`}:void 0;return(0,s.jsxs)("div",{ref:n,...r,...a,className:"effect-item",style:o,children:[(0,s.jsx)("div",{className:"effect-icon",children:e.icon}),(0,s.jsx)("div",{className:"effect-name",children:e.name}),(0,s.jsx)("div",{className:"effect-description",children:e.description})]})},i=()=>(0,s.jsxs)("div",{className:"effect-library",children:[(0,s.jsxs)("div",{className:"effect-library-header",children:[(0,s.jsx)("h3",{children:"Effect Library"}),(0,s.jsx)("p",{children:"Drag effects to enhance your story"})]}),(0,s.jsx)("div",{className:"effect-list",children:[{id:"highlight",name:"Highlight",description:"Emphasize key moments",icon:"âœ¨",type:"emphasis"},{id:"dramatic",name:"Dramatic Pause",description:"Add suspense",icon:"ðŸŽ­",type:"pacing"},{id:"atmosphere",name:"Atmosphere",description:"Set the mood",icon:"ðŸŒŸ",type:"mood"},{id:"transition",name:"Transition",description:"Smooth scene changes",icon:"ðŸ”„",type:"flow"}].map((e=>(0,s.jsx)(n,{effect:e},e.id)))})]})},832:(e,a,r)=>{var t=r(540),s=r(338),n=r(243),i=r(828),o=r(438),d=r(375),c=(r(36),r(848));const l={paragraph:t.memo((({data:e,id:a})=>{const{setNodeRef:r}=(0,d.zM)({id:`droppable-${a}`,data:{nodeId:a}});return(0,c.jsxs)("div",{ref:r,className:`paragraph-node ${e.globalStyle||"realistic"}-style`,children:[(0,c.jsx)(n.h7,{type:"target",position:n.yX.Left}),(0,c.jsxs)("div",{className:"node-header",children:["Paragraph ",e.index+1]}),(0,c.jsx)("div",{className:"node-content",children:e.text}),(0,c.jsx)("div",{className:"node-effects",children:e.effects&&e.effects.map(((a,r)=>(0,c.jsxs)("div",{className:"node-effect-tag",children:[(0,c.jsx)("span",{children:a.icon}),a.name,(0,c.jsx)("span",{className:"remove-effect",onClick:()=>e.onRemoveEffect(e.index,a.id),children:"Ã—"})]},r)))}),(0,c.jsxs)("div",{className:"node-controls",children:[(0,c.jsx)("button",{className:"btn btn-primary btn-sm w-100 mb-2",onClick:()=>e.onGenerateCard(e.index),disabled:e.isGenerating,children:e.isGenerating?"Generating...":"Generate Card"}),e.imageUrl&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:"node-preview mt-2",children:(0,c.jsxs)("div",{className:"image-container position-relative",children:[(0,c.jsx)("img",{src:e.imageUrl,alt:"Generated preview",className:"img-fluid rounded",onClick:()=>e.onExpandImage(e.imageUrl)}),(0,c.jsx)("div",{className:"image-prompt-overlay",children:e.imagePrompt})]})}),(0,c.jsx)("div",{className:"d-flex gap-2 mt-2",children:(0,c.jsxs)("button",{className:"btn btn-secondary btn-sm flex-grow-1",onClick:()=>e.onRegenerateImage(e.index),disabled:e.isRegenerating,children:[(0,c.jsx)("i",{className:"bi bi-arrow-clockwise"})," Regenerate Image"]})})]}),e.audioUrl&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{className:"audio-player mt-2",children:(0,c.jsxs)("audio",{controls:!0,className:"w-100",children:[(0,c.jsx)("source",{src:e.audioUrl,type:"audio/wav"}),"Your browser does not support the audio element."]},e.audioUrl)}),(0,c.jsxs)("button",{className:"btn btn-secondary btn-sm w-100 mt-2",onClick:()=>e.onRegenerateAudio(e.index),disabled:e.isRegeneratingAudio,children:[(0,c.jsx)("i",{className:"bi bi-arrow-clockwise"})," Regenerate Audio"]})]})]}),(0,c.jsx)(n.h7,{type:"source",position:n.yX.Right})]})}))},p=({story:e,onStyleUpdate:a})=>{const[r,s,d]=(0,n.ck)([]),[p,m,g]=(0,n.fM)([]),[h,f]=(0,t.useState)("realistic"),[u,x]=(0,t.useState)(null),y=(0,t.useCallback)((async a=>{try{s((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isRegenerating:!0}}:e))));const r=await fetch("/story/regenerate_image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:a,text:e.paragraphs[a].text.trim(),style:h})}),t=await r.json();t.success&&s((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,imageUrl:t.image_url,imagePrompt:t.image_prompt,isRegenerating:!1}}:e))))}catch(e){console.error("Error regenerating image:",e),alert("Failed to regenerate image"),s((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isRegenerating:!1}}:e))))}}),[e?.paragraphs,h,s]),v=(0,t.useCallback)((async a=>{try{s((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isRegeneratingAudio:!0}}:e))));const r=await fetch("/story/regenerate_audio",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:a,text:e.paragraphs[a].text.trim()})}),t=await r.json();t.success&&s((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,audioUrl:t.audio_url,isRegeneratingAudio:!1}}:e))))}catch(e){console.error("Error regenerating audio:",e),alert("Failed to regenerate audio"),s((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isRegeneratingAudio:!1}}:e))))}}),[e?.paragraphs,s]),j=(0,t.useCallback)((async a=>{if(e?.paragraphs?.[a]?.text)try{s((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isGenerating:!0}}:e))));const r=e.paragraphs.map((e=>e.text)).join("\n\n"),t=await fetch("/story/generate_cards",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:a,text:e.paragraphs[a].text.trim(),story_context:r,style:h})});if(!t.ok)throw new Error("Failed to generate card");const n=t.body.getReader(),i=new TextDecoder;let o="";for(;;){const{done:e,value:r}=await n.read();if(e)break;o+=i.decode(r,{stream:!0});const t=o.split("\n");o=t.pop()||"";for(const e of t)if(e.trim())try{const r=JSON.parse(e);if("paragraph"===r.type)s((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,imageUrl:r.data.image_url,imagePrompt:r.data.image_prompt,audioUrl:r.data.audio_url,isGenerating:!1}}:e))));else if("error"===r.type)throw new Error(r.message)}catch(e){console.error("Error parsing JSON:",e)}}}catch(e){console.error("Error generating card:",e),s((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isGenerating:!1}}:e)))),alert(e.message||"Failed to generate card")}else console.error("No text found for paragraph")}),[e?.paragraphs,h,s]),b=(0,t.useCallback)((r=>{const t=r.target.value;f(t),s((e=>e.map((e=>({...e,data:{...e.data,globalStyle:t}})))));const n=e?.paragraphs?.map(((e,a)=>({index:a,image_style:t})))||[];a(n)}),[s,e?.paragraphs,a]);(0,t.useEffect)((()=>{if(!e?.paragraphs)return void console.error("No story paragraphs found");const a=e.paragraphs.map(((e,a)=>({id:`p${a}`,type:"paragraph",position:{x:a%2*300+50,y:250*Math.floor(a/2)+50},sourcePosition:"right",targetPosition:"left",connectable:!0,data:{index:a,text:e.text,globalStyle:h,imageUrl:e.image_url,imagePrompt:e.image_prompt,audioUrl:e.audio_url,onGenerateCard:j,onRegenerateImage:y,onRegenerateAudio:v,onExpandImage:x,isGenerating:!1,isRegenerating:!1,isRegeneratingAudio:!1,effects:[],onRemoveEffect:(e,a)=>{s((r=>r.map((r=>r.id===`p${e}`?{...r,data:{...r.data,effects:r.data.effects.filter((e=>e.id!==a))}}:r))))}}})));s(a)}),[e?.paragraphs,h,j,y,v,s]),(0,t.useEffect)((()=>{const e=document.querySelectorAll('input[name="imageStyle"]'),a=e=>b(e);return e.forEach((e=>{e.addEventListener("change",a)})),()=>{e.forEach((e=>{e.removeEventListener("change",a)}))}}),[b]);const N=(0,t.useCallback)((e=>{if(e.source===e.target)return;const a={...e,type:"smoothstep",animated:!0,style:{stroke:"var(--bs-primary)",strokeWidth:2}};m((e=>(0,n.rN)(a,e)))}),[m]);return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)("div",{style:{width:"100%",height:"600px"},className:"node-editor-root",children:(0,c.jsxs)(n.Gc,{nodes:r,edges:p,onNodesChange:d,onEdgesChange:g,onConnect:N,nodeTypes:l,fitView:!0,style:{background:"var(--bs-dark)"},minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},connectOnClick:!0,children:[(0,c.jsx)(i.V,{}),(0,c.jsx)(o.H,{})]})}),u&&(0,c.jsx)("div",{className:"modal-backdrop",onClick:()=>x(null),children:(0,c.jsxs)("div",{className:"preview-modal",onClick:e=>e.stopPropagation(),children:[(0,c.jsx)("button",{type:"button",className:"close-button",onClick:()=>x(null),children:"Ã—"}),(0,c.jsx)("div",{className:"preview-content",children:(0,c.jsx)("img",{src:u,alt:"Full preview"})})]})})]})},m=t.memo(p);var g=r(831),h=r(626);class f extends t.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0}}componentDidCatch(e,a){console.error("Error caught by boundary:",e,a)}render(){return this.state.hasError?(0,c.jsx)("div",{className:"alert alert-danger",children:"Something went wrong. Please try refreshing the page."}):this.props.children}}const u=({story:e})=>{const[a,r]=t.useState(null);return(0,c.jsx)(d.Mp,{onDragEnd:a=>{const{active:t,over:s}=a;if(s&&t.data.current){const a=t.data.current,r=s.id.replace("droppable-",""),n=parseInt(r.replace("p",""));e.paragraphs[n]&&(e.paragraphs[n].effects=[...e.paragraphs[n].effects||[],a],fetch("/story/update_style",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paragraphs:e.paragraphs.map(((e,a)=>({index:a,effects:e.effects||[]})))})}).catch((e=>{console.error("Error updating effects:",e)})))}r(null)},onDragStart:e=>{r(e.active.data.current)},modifiers:[g.Q_],children:(0,c.jsxs)("div",{className:"customization-wrapper",children:[(0,c.jsx)(m,{story:e,onStyleUpdate:e=>{fetch("/story/update_style",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paragraphs:e})}).catch((e=>{console.error("Error updating style:",e)}))}}),(0,c.jsx)(h.A,{}),(0,c.jsx)(d.Hd,{children:a?(0,c.jsxs)("div",{className:"effect-item dragging",children:[(0,c.jsx)("span",{className:"effect-icon",children:a.icon}),(0,c.jsx)("span",{className:"effect-name",children:a.name})]}):null})]})})};document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("node-editor");if(!e)return void console.error("Node editor container not found");let a;try{const r=e.getAttribute("data-story");if(!r)throw new Error("No story data attribute found");a=JSON.parse(r),a.paragraphs&&(a.paragraphs=a.paragraphs.map((e=>({...e,effects:e.effects||[]}))))}catch(e){return void console.error("Failed to parse story data:",e)}(0,s.H)(e).render((0,c.jsx)(f,{children:(0,c.jsx)(u,{story:a})}))}))}},r={};function t(e){var s=r[e];if(void 0!==s)return s.exports;var n=r[e]={id:e,exports:{}};return a[e](n,n.exports,t),n.exports}t.m=a,e=[],t.O=(a,r,s,n)=>{if(!r){var i=1/0;for(l=0;l<e.length;l++){for(var[r,s,n]=e[l],o=!0,d=0;d<r.length;d++)(!1&n||i>=n)&&Object.keys(t.O).every((e=>t.O[e](r[d])))?r.splice(d--,1):(o=!1,n<i&&(i=n));if(o){e.splice(l--,1);var c=s();void 0!==c&&(a=c)}}return a}n=n||0;for(var l=e.length;l>0&&e[l-1][2]>n;l--)e[l]=e[l-1];e[l]=[r,s,n]},t.n=e=>{var a=e&&e.__esModule?()=>e.default:()=>e;return t.d(a,{a}),a},t.d=(e,a)=>{for(var r in a)t.o(a,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:a[r]})},t.o=(e,a)=>Object.prototype.hasOwnProperty.call(e,a),(()=>{var e={365:0,792:0};t.O.j=a=>0===e[a];var a=(a,r)=>{var s,n,[i,o,d]=r,c=0;if(i.some((a=>0!==e[a]))){for(s in o)t.o(o,s)&&(t.m[s]=o[s]);if(d)var l=d(t)}for(a&&a(r);c<i.length;c++)n=i[c],t.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return t.O(l)},r=self.webpackChunkworkspace=self.webpackChunkworkspace||[];r.forEach(a.bind(null,0)),r.push=a.bind(null,r.push.bind(r))})(),t.nc=void 0;var s=t.O(void 0,[966],(()=>t(832)));s=t.O(s)})();
//# sourceMappingURL=main.bundle.js.map