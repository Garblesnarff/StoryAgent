(()=>{"use strict";var e,a={832:(e,a,r)=>{var t=r(540),o=r(338),n=r(64),i=r(828),s=r(438);r(36);const l={paragraph:t.memo((({data:e})=>{const{index:a,text:r,imageUrl:o,audioUrl:i,imagePrompt:s,onGenerateImage:l,onGenerateAudio:m,onRegenerateImage:d,onRegenerateAudio:c,onExpandImage:g,isGeneratingImage:p,isGeneratingAudio:u,isRegenerating:h,isRegeneratingAudio:y,imageProgress:b,audioProgress:E,imageError:v,audioError:w}=e,f=`paragraph-node ${e.globalStyle||"realistic"}-style`;return t.createElement("div",{className:f},t.createElement(n.h7,{type:"target",position:n.yX.Left}),t.createElement("div",{className:"node-content"},t.createElement("div",{className:"text-content mb-2"},r),t.createElement("div",{className:"generation-controls mb-2"},t.createElement("div",{className:"generation-control"},t.createElement("button",{className:"btn btn-primary btn-sm w-100 mb-1",onClick:()=>l(a),disabled:p||h},t.createElement("i",{className:"bi bi-image me-1"}),p?" Generating...":h?" Regenerating...":" Generate Image"),v&&t.createElement("div",{className:"alert alert-danger p-2 mb-2"},t.createElement("small",null,v),t.createElement("button",{className:"btn btn-sm btn-outline-danger w-100 mt-1",onClick:()=>l(a,!0)},t.createElement("i",{className:"bi bi-arrow-clockwise me-1"}),"Retry")),t.createElement("div",{className:"progress mt-1",style:{height:"4px",opacity:p||h?1:0,transition:"opacity 0.3s ease"}},t.createElement("div",{className:"progress-bar progress-bar-striped progress-bar-animated bg-primary",role:"progressbar",style:{width:`${b||0}%`},"aria-valuenow":b||0,"aria-valuemin":"0","aria-valuemax":"100"}))),t.createElement("div",{className:"generation-control mt-2"},t.createElement("button",{className:"btn btn-primary btn-sm w-100 mb-1",onClick:()=>m(a),disabled:u||y},t.createElement("i",{className:"bi bi-volume-up me-1"}),u?" Generating...":y?" Regenerating...":" Generate Audio"),w&&t.createElement("div",{className:"alert alert-danger p-2 mb-2"},t.createElement("small",null,w),t.createElement("button",{className:"btn btn-sm btn-outline-danger w-100 mt-1",onClick:()=>m(a,!0)},t.createElement("i",{className:"bi bi-arrow-clockwise me-1"}),"Retry")),t.createElement("div",{className:"progress mt-1",style:{height:"4px",opacity:u||y?1:0,transition:"opacity 0.3s ease"}},t.createElement("div",{className:"progress-bar progress-bar-striped progress-bar-animated bg-primary",role:"progressbar",style:{width:`${E||0}%`},"aria-valuenow":E||0,"aria-valuemin":"0","aria-valuemax":"100"})))),o&&!v&&t.createElement(t.Fragment,null,t.createElement("div",{className:"node-preview mt-2"},t.createElement("div",{className:"image-container position-relative"},t.createElement("img",{src:o,alt:"Generated preview",className:"img-fluid rounded"}),t.createElement("div",{className:"expand-icon",onClick:()=>g(o)},t.createElement("i",{className:"bi bi-arrows-fullscreen"})),t.createElement("div",{className:"copy-prompt-icon",onClick:e=>{e.stopPropagation(),navigator.clipboard.writeText(s).then((()=>{const a=document.createElement("div");a.className="toast-notification",a.innerHTML='\n                                                <i class="bi bi-clipboard-check me-2"></i>\n                                                Prompt copied to clipboard!\n                                            ',document.body.appendChild(a),a.offsetHeight,requestAnimationFrame((()=>{a.classList.add("show")}));const r=e.currentTarget;r&&(r.innerHTML='<i class="bi bi-check"></i>',r.style.background="rgba(40, 167, 69, 0.8)",setTimeout((()=>{r.innerHTML='<i class="bi bi-clipboard"></i>',r.style.background="",a.classList.remove("show"),setTimeout((()=>{a.remove()}),300)}),2e3))}))},title:"Copy image prompt"},t.createElement("i",{className:"bi bi-clipboard"})),t.createElement("div",{className:"image-prompt-overlay"},s))),t.createElement("div",{className:"d-flex gap-2 mt-2"},t.createElement("button",{className:"btn btn-secondary btn-sm flex-grow-1",onClick:()=>d(a),disabled:h},t.createElement("i",{className:"bi bi-arrow-clockwise"})," Regenerate Image"))),i&&!w&&t.createElement(t.Fragment,null,t.createElement("div",{className:"audio-player mt-2"},t.createElement("audio",{controls:!0,className:"w-100",key:i},t.createElement("source",{src:i,type:"audio/wav"}),"Your browser does not support the audio element.")),t.createElement("button",{className:"btn btn-secondary btn-sm w-100 mt-2",onClick:()=>c(a),disabled:y},t.createElement("i",{className:"bi bi-arrow-clockwise"})," Regenerate Audio"))),t.createElement(n.h7,{type:"source",position:n.yX.Right}))}))},m=({story:e,onStyleUpdate:a})=>{const[r,o,m]=(0,n.ck)([]),[d,c,g]=(0,n.fM)([]),[p,u]=(0,t.useState)("realistic"),[h,y]=(0,t.useState)(null),b=(0,t.useCallback)((async a=>{try{o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isRegenerating:!0,imageProgress:0,imageError:null}}:e))));let r=0;const t=setInterval((()=>{r=Math.min(r+2,90),o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,imageProgress:r}}:e))))}),100),n=e.paragraphs.slice(0,a).map((e=>`Text: ${e.text}\n${e.image_prompt?`Previous Image Prompt: ${e.image_prompt}\n`:""}`)).join("\n\n"),i=await fetch("/story/regenerate_image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:a,text:e.paragraphs[a].text.trim(),story_context:n,style:p})}),s=await i.json();if(clearInterval(t),!i.ok)throw new Error(s.error||"Failed to regenerate image");if(!s.success)throw new Error(s.error||"Failed to regenerate image");o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,imageUrl:s.image_url,imagePrompt:s.image_prompt,isRegenerating:!1,imageProgress:100,imageError:null}}:e))))}catch(e){console.error("Error regenerating image:",e),o((r=>r.map((r=>r.id===`p${a}`?{...r,data:{...r.data,isRegenerating:!1,imageProgress:0,imageError:e.message||"Failed to regenerate image. Please try again."}}:r))))}}),[e?.paragraphs,p,o]),E=(0,t.useCallback)((async a=>{try{o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isRegeneratingAudio:!0,audioProgress:0,audioError:null}}:e))));let r=0;const t=setInterval((()=>{r=Math.min(r+2,90),o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,audioProgress:r}}:e))))}),100),n=await fetch("/story/regenerate_audio",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:a,text:e.paragraphs[a].text.trim()})}),i=await n.json();if(clearInterval(t),!n.ok)throw new Error(i.error||"Failed to regenerate audio");if(!i.success)throw new Error(i.error||"Failed to regenerate audio");o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,audioUrl:i.audio_url,isRegeneratingAudio:!1,audioProgress:100,audioError:null}}:e))))}catch(e){console.error("Error regenerating audio:",e),o((r=>r.map((r=>r.id===`p${a}`?{...r,data:{...r.data,isRegeneratingAudio:!1,audioProgress:0,audioError:e.message||"Failed to regenerate audio. Please try again."}}:r))))}}),[e?.paragraphs,o]),v=(0,t.useCallback)((async(a,r=!1)=>{if(e?.paragraphs?.[a]?.text)try{o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isGeneratingImage:!0,imageProgress:0,imageError:null}}:e))));let t=0;const n=setInterval((()=>{t=Math.min(t+2,90),o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,imageProgress:t}}:e))))}),100),i=e.paragraphs.slice(0,a).map((e=>`Text: ${e.text}\n${e.image_prompt?`Previous Image Prompt: ${e.image_prompt}\n`:""}`)).join("\n\n"),s=await fetch("/story/generate_image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:a,text:e.paragraphs[a].text.trim(),story_context:i,style:p,is_retry:r})}),l=await s.json();if(clearInterval(n),!s.ok)throw new Error(l.error||"Failed to generate image");if(!l.success)throw new Error(l.error||"Failed to generate image");o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,imageUrl:l.image_url,imagePrompt:l.image_prompt,isGeneratingImage:!1,imageProgress:100,imageError:null}}:e))))}catch(e){console.error("Error generating image:",e),clearInterval(progressInterval),o((r=>r.map((r=>r.id===`p${a}`?{...r,data:{...r.data,isGeneratingImage:!1,imageProgress:0,imageError:e.message||"Failed to generate image. Please try again."}}:r))))}else console.error("No text found for paragraph")}),[e?.paragraphs,p,o]),w=(0,t.useCallback)((async(a,r=!1)=>{if(e?.paragraphs?.[a]?.text)try{o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,isGeneratingAudio:!0,audioProgress:0,audioError:null}}:e))));let t=0;const n=setInterval((()=>{t=Math.min(t+2,90),o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,audioProgress:t}}:e))))}),100),i=await fetch("/story/generate_audio",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({index:a,text:e.paragraphs[a].text.trim(),is_retry:r})}),s=await i.json();if(clearInterval(n),!i.ok)throw new Error(s.error||"Failed to generate audio");if(!s.success)throw new Error(s.error||"Failed to generate audio");o((e=>e.map((e=>e.id===`p${a}`?{...e,data:{...e.data,audioUrl:s.audio_url,isGeneratingAudio:!1,audioProgress:100,audioError:null}}:e))))}catch(e){console.error("Error generating audio:",e),clearInterval(progressInterval),o((r=>r.map((r=>r.id===`p${a}`?{...r,data:{...r.data,isGeneratingAudio:!1,audioProgress:0,audioError:e.message||"Failed to generate audio. Please try again."}}:r))))}else console.error("No text found for paragraph")}),[e?.paragraphs,o]),f=(0,t.useCallback)((r=>{const t=r.target.value;u(t),o((e=>e.map((e=>({...e,data:{...e.data,globalStyle:t}})))));const n=e?.paragraphs?.map(((e,a)=>({index:a,image_style:t})))||[];a(n)}),[o,e?.paragraphs,a]);(0,t.useEffect)((()=>{if(!e?.paragraphs)return void console.error("No story paragraphs found");const a=e.paragraphs.map(((e,a)=>({id:`p${a}`,type:"paragraph",position:{x:a%2*300+50,y:250*Math.floor(a/2)+50},sourcePosition:"right",targetPosition:"left",connectable:!0,data:{index:a,text:e.text,globalStyle:p,imageUrl:e.image_url,imagePrompt:e.image_prompt,audioUrl:e.audio_url,onGenerateImage:v,onGenerateAudio:w,onRegenerateImage:b,onRegenerateAudio:E,onExpandImage:y,isGeneratingImage:!1,isGeneratingAudio:!1,isRegenerating:!1,isRegeneratingAudio:!1,imageProgress:0,audioProgress:0,imageError:null,audioError:null}})));o(a)}),[e?.paragraphs,p,v,w,b,E,o]),(0,t.useEffect)((()=>{const e=document.querySelectorAll('input[name="imageStyle"]'),a=e=>f(e);return e.forEach((e=>{e.addEventListener("change",a)})),()=>{e.forEach((e=>{e.removeEventListener("change",a)}))}}),[f]);const N=(0,t.useCallback)((e=>{if(e.source===e.target)return;const a={...e,type:"smoothstep",animated:!0,style:{stroke:"var(--bs-primary)",strokeWidth:2}};c((e=>(0,n.rN)(a,e)))}),[c]);return t.createElement(t.Fragment,null,t.createElement("div",{style:{width:"100%",height:"600px"},className:"node-editor-root"},t.createElement(n.Gc,{nodes:r,edges:d,onNodesChange:m,onEdgesChange:g,onConnect:N,nodeTypes:l,fitView:!0,style:{background:"var(--bs-dark)"},minZoom:.1,maxZoom:4,defaultViewport:{x:0,y:0,zoom:1},connectOnClick:!0},t.createElement(i.V,null),t.createElement(s.H,null))),h&&t.createElement("div",{className:"modal-backdrop",onClick:()=>y(null)},t.createElement("div",{className:"preview-modal",onClick:e=>e.stopPropagation()},t.createElement("button",{type:"button",className:"close-button",onClick:()=>y(null)},"×"),t.createElement("div",{className:"preview-content"},t.createElement("img",{src:h,alt:"Full preview"})))))},d=t.memo(m);class c extends t.Component{constructor(e){super(e),this.state={hasError:!1}}static getDerivedStateFromError(e){return{hasError:!0}}componentDidCatch(e,a){console.error("Error caught by boundary:",e,a)}render(){return this.state.hasError?t.createElement("div",{className:"alert alert-danger"},"Something went wrong. Please try refreshing the page."):this.props.children}}document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("node-editor");if(!e)return void console.error("Node editor container not found");let a;try{const r=e.getAttribute("data-story");if(!r)throw new Error("No story data attribute found");a=JSON.parse(r)}catch(e){return console.error("Failed to parse story data:",e),void r("Failed to load story data. Please generate a story first.")}function r(a){e.innerHTML=`\n            <div class="alert alert-warning text-center">\n                <h4 class="alert-heading">Oops!</h4>\n                <p>${a}</p>\n                <hr>\n                <p class="mb-0">You will be redirected to the story generation page...</p>\n            </div>\n        `,setTimeout((()=>{window.location.href="/"}),3e3)}a&&a.paragraphs&&a.paragraphs.length?(0,o.H)(e).render(t.createElement(c,null,t.createElement(d,{story:a,onStyleUpdate:e=>{fetch("/story/update_style",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paragraphs:e.map(((e,a)=>({index:a,image_style:e.image_style||"realistic"})))})}).then((e=>{if(!e.ok){if(403===e.status)throw new Error("Session expired. Please generate a new story.");return e.json().then((e=>{throw new Error(e.error||"Failed to update style")}))}return e.json()})).then((e=>{if(!e.success)throw new Error(e.error||"Failed to update style")})).catch((e=>{console.error("Error updating style:",e),e.message.includes("Session expired")?r(e.message):alert(e.message||"Failed to update style")}))}}))):r("No story found. Please generate a story first.")}))}},r={};function t(e){var o=r[e];if(void 0!==o)return o.exports;var n=r[e]={id:e,exports:{}};return a[e](n,n.exports,t),n.exports}t.m=a,e=[],t.O=(a,r,o,n)=>{if(!r){var i=1/0;for(d=0;d<e.length;d++){for(var[r,o,n]=e[d],s=!0,l=0;l<r.length;l++)(!1&n||i>=n)&&Object.keys(t.O).every((e=>t.O[e](r[l])))?r.splice(l--,1):(s=!1,n<i&&(i=n));if(s){e.splice(d--,1);var m=o();void 0!==m&&(a=m)}}return a}n=n||0;for(var d=e.length;d>0&&e[d-1][2]>n;d--)e[d]=e[d-1];e[d]=[r,o,n]},t.n=e=>{var a=e&&e.__esModule?()=>e.default:()=>e;return t.d(a,{a}),a},t.d=(e,a)=>{for(var r in a)t.o(a,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:a[r]})},t.o=(e,a)=>Object.prototype.hasOwnProperty.call(e,a),(()=>{var e={792:0};t.O.j=a=>0===e[a];var a=(a,r)=>{var o,n,[i,s,l]=r,m=0;if(i.some((a=>0!==e[a]))){for(o in s)t.o(s,o)&&(t.m[o]=s[o]);if(l)var d=l(t)}for(a&&a(r);m<i.length;m++)n=i[m],t.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return t.O(d)},r=self.webpackChunkworkspace=self.webpackChunkworkspace||[];r.forEach(a.bind(null,0)),r.push=a.bind(null,r.push.bind(r))})(),t.nc=void 0;var o=t.O(void 0,[224,765,489],(()=>t(832)));o=t.O(o)})();